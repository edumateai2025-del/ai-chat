<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Educator Chat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#fff;display:flex;justify-content:center;align-items:center;height:100vh;}
.ai-container{width:95vw;max-width:600px;height:95vh;display:flex;flex-direction:column;background:#fafafa;border-radius:12px;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,0.15);}
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#fff;border-bottom:1px solid #e6e6e6;font-size:20px;}
.central{flex:1;overflow-y:auto;display:flex;flex-direction:column;padding:14px;gap:12px;scroll-behavior:smooth;}
.message{max-width:85%;padding:10px 14px;border-radius:14px;font-size:15px;line-height:1.45;white-space:pre-wrap;}
.user-msg{align-self:flex-end;background:#007aff;color:#fff;border-bottom-right-radius:4px;}
.ai-msg{align-self:flex-start;background:#e5e5e5;color:#111;border-bottom-left-radius:4px;}
.typing { font-style: italic; color: #555; }
.bottom-bar{display:flex;gap:8px;padding:12px 14px;border-top:1px solid #e6e6e6;background:#fff;}
.bottom-bar input{flex:1;border-radius:24px;border:1px solid #d0d0d0;padding:12px 15px;font-size:15px;}
#sendBtn{background:#007aff;color:#fff;border:none;width:42px;height:42px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:17px;cursor:pointer;}
#panel{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:2px 0 10px rgba(0,0,0,0.2);transform:translateX(-100%);transition:.3s;display:flex;flex-direction:column;z-index:10000;}
#panel.active{transform:translateX(0);}
#panelContent{flex:1;overflow-y:auto;padding:12px;}
#panelContent div{background:#f4f4f4;padding:10px;border-radius:6px;margin-bottom:6px;cursor:pointer;}
#panelFooter{padding:12px;border-top:1px solid #ccc;text-align:center;}
#settingsModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:280px;background:#fff;padding:20px 24px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.25);display:none;z-index:20000;}
.setting-item{margin-bottom:12px;font-size:15px;}
</style>
</head>
<body>

<div class="ai-container">
  <div class="top-bar">
    <i class="fas fa-bars" id="hamburger"></i>
    <i class="fas fa-user-circle"></i>
  </div>

  <div class="central" id="chatArea"></div>

  <div class="bottom-bar">
    <input type="text" id="chatInput" placeholder="Ask AI Educator">
    <button id="sendBtn"><i class="fas fa-arrow-up"></i></button>
  </div>
</div>

<!-- slide panel -->
<div id="panel">
  <div id="panelContent">
    <div id="newChatBtn">âž• New Chat</div>
  </div>
  <div id="panelFooter">
    <i class="fas fa-cog" id="openSettings"></i>
  </div>
</div>

<!-- settings modal -->
<div id="settingsModal">
  <h3>Settings</h3>
  <div class="setting-item">
    <label><input type="checkbox" id="darkModeToggle"> Dark Mode</label>
  </div>
  <div class="setting-item">
    <label>AI Mode</label>
    <select id="aiModeSelect">
      <option value="educator">Educator</option>
      <option value="researcher">Researcher</option>
      <option value="friendly">Friendly Tutor</option>
    </select>
  </div>
  <button id="closeSettings">Close</button>
</div>

<script>
const chatArea = document.getElementById("chatArea");
const sendBtn = document.getElementById("sendBtn");
const chatInput = document.getElementById("chatInput");
const aiModeSelect = document.getElementById("aiModeSelect");

// ----------------- Panel & Settings -----------------
document.getElementById("hamburger").onclick = () => {
  document.getElementById("panel").classList.toggle("active");
};
document.getElementById("openSettings").onclick = () => {
  document.getElementById("settingsModal").style.display = "block";
};
document.getElementById("closeSettings").onclick = () => {
  document.getElementById("settingsModal").style.display = "none";
};
document.getElementById("darkModeToggle").onchange = (e) => {
  document.body.style.background = e.target.checked ? "#111" : "#fff";
};

// ----------------- Utility Functions -----------------
function addMessage(text, sender, extraClass = "") {
  const div = document.createElement("div");
  div.className = `message ${sender}-msg ${extraClass}`;
  div.textContent = text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
  return div;
}

// ----------------- New Chat -----------------
document.getElementById("newChatBtn").onclick = () => {
  chatArea.innerHTML = "";
  saveMessages();
};

// ----------------- Typing Indicator -----------------
let typingDiv = null;

// ----------------- Send to Serverless GPT-5 Nano -----------------
async function sendToAI(userMessage) {
  typingDiv = addMessage("AI is typing...", "ai", "typing");

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: userMessage, mode: aiModeSelect.value })
    });

    const data = await res.json();

    if (typingDiv) typingDiv.remove();

    // Display AI response
    const replyText = data.reply || "No response ðŸ˜”";
    replyText.split('\n').forEach(line => {
      if (line.trim() !== "") addMessage(line, "ai");
    });

  } catch (err) {
    console.error(err);
    if (typingDiv) typingDiv.remove();
    addMessage("âš ï¸ Server error â€” check backend", "ai");
  }

  saveMessages();
}

// ----------------- Send Message Handler -----------------
function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;
  addMessage(text, "user");
  chatInput.value = "";
  sendToAI(text);
}

// ----------------- Bind Send Events -----------------
sendBtn.onclick = sendMessage;
chatInput.onkeydown = (e) => { if (e.key === "Enter") sendMessage(); };

// ----------------- LocalStorage Save & Load -----------------
function saveMessages() {
  localStorage.setItem("chatHTML", chatArea.innerHTML);
}
window.onload = () => {
  const saved = localStorage.getItem("chatHTML");
  if (saved) chatArea.innerHTML = saved;
};
</script>
</body>
</html>
